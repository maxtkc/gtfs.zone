# GTFS Table Constants Migration Plan

## Overview

Replace hardcoded GTFS table name strings throughout the codebase with auto-generated, type-safe constants derived from the GTFS specification.

## Current State Analysis

### ‚úÖ String References Found
- **~300+ occurrences** of hardcoded table names like `'agency.txt'`, `'stops.txt'`, etc.
- **Main areas affected**:
  - Database operations (`gtfs-relationships.ts`, `gtfs-parser.ts`)
  - Validation logic (`gtfs-validator.ts`)
  - Type generation (`generate-gtfs-types.ts`)
  - Utility functions (`gtfs-caster.ts`, `zod-tooltip-helper.ts`)

### ‚úÖ Infrastructure Complete
- **Auto-generated constants** from GTFS specification
- **Type safety** with `GTFSTableName` union type
- **IDE support** with autocomplete and refactoring

## Generated Infrastructure

### GTFS_TABLES Constants
```typescript
export const GTFS_TABLES = {
  AGENCY: 'agency.txt',
  STOPS: 'stops.txt',
  ROUTES: 'routes.txt',
  TRIPS: 'trips.txt',
  STOP_TIMES: 'stop_times.txt',
  CALENDAR: 'calendar.txt',
  CALENDAR_DATES: 'calendar_dates.txt',
  FARE_ATTRIBUTES: 'fare_attributes.txt',
  FARE_RULES: 'fare_rules.txt',
  TIMEFRAMES: 'timeframes.txt',
  RIDER_CATEGORIES: 'rider_categories.txt',
  FARE_MEDIA: 'fare_media.txt',
  FARE_PRODUCTS: 'fare_products.txt',
  FARE_LEG_RULES: 'fare_leg_rules.txt',
  FARE_LEG_JOIN_RULES: 'fare_leg_join_rules.txt',
  FARE_TRANSFER_RULES: 'fare_transfer_rules.txt',
  AREAS: 'areas.txt',
  STOP_AREAS: 'stop_areas.txt',
  NETWORKS: 'networks.txt',
  ROUTE_NETWORKS: 'route_networks.txt',
  SHAPES: 'shapes.txt',
  FREQUENCIES: 'frequencies.txt',
  TRANSFERS: 'transfers.txt',
  PATHWAYS: 'pathways.txt',
  LEVELS: 'levels.txt',
  LOCATION_GROUPS: 'location_groups.txt',
  LOCATION_GROUP_STOPS: 'location_group_stops.txt',
  LOCATIONS_GEOJSON: 'locations.geojson',
  BOOKING_RULES: 'booking_rules.txt',
  TRANSLATIONS: 'translations.txt',
  FEED_INFO: 'feed_info.txt',
  ATTRIBUTIONS: 'attributions.txt',
} as const;

export type GTFSTableName = typeof GTFS_TABLES[keyof typeof GTFS_TABLES];
```

### Auto-Generation Process
- Generated by `scripts/generate-gtfs-types.ts`
- Source: `src/gtfs-spec.json` (scraped from gtfs.org)
- Command: `npm run generate-gtfs-types`
- Includes all 32 official GTFS files

## Migration Strategy

### Phase 1: Database Operations (High Impact)
**Target Files:**
- `src/utils/gtfs-relationships.ts` - 15+ references
- `src/modules/gtfs-parser.ts` - 10+ references

**Example Migration:**
```typescript
// OLD ‚ùå
const stop = this.database['stops.txt']?.get(stop_id);
const routes = this.getFileDataSyncTyped('routes.txt');

// NEW ‚úÖ
import { GTFS_TABLES } from '../types/gtfs';
const stop = this.database[GTFS_TABLES.STOPS]?.get(stop_id);
const routes = this.getFileDataSyncTyped(GTFS_TABLES.ROUTES);
```

### Phase 2: Validation Logic (Medium Impact)
**Target Files:**
- `src/modules/gtfs-validator.ts` - 30+ references

**Example Migration:**
```typescript
// OLD ‚ùå
const agencies = this.gtfsParser.getFileDataSyncTyped('agency.txt');
this.addError('agency.txt is empty', 'EMPTY_FILE', 'agency.txt');

// NEW ‚úÖ
import { GTFS_TABLES } from '../types/gtfs';
const agencies = this.gtfsParser.getFileDataSyncTyped(GTFS_TABLES.AGENCY);
this.addError(`${GTFS_TABLES.AGENCY} is empty`, 'EMPTY_FILE', GTFS_TABLES.AGENCY);
```

### Phase 3: Utility Functions (Low Impact)
**Target Files:**
- `src/utils/gtfs-caster.ts` - 3+ references
- `src/utils/zod-tooltip-helper.ts` - 8+ references
- `scripts/generate-gtfs-types.ts` - 25+ references

### Phase 4: Cleanup and Enforcement
- Remove remaining hardcoded strings
- Add ESLint rule to prevent regression
- Update documentation

## Implementation Benefits

### üéØ Type Safety
- **Compile-time validation** of table names
- **IDE autocomplete** and refactoring support
- **Catch typos** at build time instead of runtime

### üîß Maintainability
- **Single source of truth** for table names
- **Automatic updates** when GTFS spec changes
- **Easier refactoring** and renaming

### üìä Spec Compliance
- **Always in sync** with official GTFS specification
- **Automatic inclusion** of new GTFS files
- **Consistent naming** across entire codebase

### üöÄ Developer Experience
- **IntelliSense support** in IDEs
- **Reduced cognitive load** (no need to remember exact filenames)
- **Refactoring safety** with TypeScript

## Migration Checklist

### ‚úÖ Infrastructure Complete
- [x] Generate GTFS_TABLES constants from spec
- [x] Add GTFSTableName type definition
- [x] Update generation script
- [x] Test constants generation
- [x] Create migration plan document

### üîÑ Phase 1: Database Operations (High Impact)
- [ ] **`src/utils/gtfs-relationships.ts`** (15+ references)
  - [ ] Replace `'stops.txt'` references (6 occurrences)
  - [ ] Replace `'routes.txt'` references (2 occurrences)
  - [ ] Replace `'trips.txt'` references (3 occurrences)
  - [ ] Replace `'stop_times.txt'` references (3 occurrences)
  - [ ] Replace `'calendar.txt'` reference (1 occurrence)
  - [ ] Replace `'calendar_dates.txt'` reference (1 occurrence)
  - [ ] Replace `'levels.txt'` reference (1 occurrence)
  - [ ] Replace `'shapes.txt'` reference (1 occurrence)
  - [ ] Replace `'frequencies.txt'` reference (1 occurrence)
  - [ ] Add GTFS_TABLES import
  - [ ] Test relationship functionality

- [ ] **`src/modules/gtfs-parser.ts`** (10+ references)
  - [ ] Replace hardcoded strings in data initialization (6 occurrences)
  - [ ] Replace strings in getRouteShapes method (3 occurrences)
  - [ ] Replace strings in getStopsGeoJSON method (1 occurrence)
  - [ ] Replace strings in getRoutesGeoJSON method (1 occurrence)
  - [ ] Replace strings in generateShapeGeoJSON method (3 occurrences)
  - [ ] Add GTFS_TABLES import
  - [ ] Test parser functionality

### üîÑ Phase 2: Validation Logic (Medium Impact)
- [ ] **`src/modules/gtfs-validator.ts`** (30+ references)
  - [ ] Replace required files array (5 occurrences)
  - [ ] Replace calendar files array (2 occurrences)
  - [ ] Replace validateAgencies method (8 occurrences)
  - [ ] Replace validateRoutes method (8 occurrences)
  - [ ] Replace validateStops method (6 occurrences)
  - [ ] Replace validateTrips method (5 occurrences)
  - [ ] Replace validateStopTimes method (8 occurrences)
  - [ ] Replace validateCalendar method (6 occurrences)
  - [ ] Replace validateShapes method (3 occurrences)
  - [ ] Add GTFS_TABLES import
  - [ ] Test validation functionality

### üîÑ Phase 3: Utility Functions (Low Impact)
- [ ] **`src/utils/gtfs-caster.ts`** (3+ references)
  - [ ] Replace switch case statements (3 occurrences)
  - [ ] Add GTFS_TABLES import
  - [ ] Test type casting functionality

- [ ] **`src/utils/zod-tooltip-helper.ts`** (8+ references)
  - [ ] Replace field description mapping keys (8 occurrences)
  - [ ] Add GTFS_TABLES import
  - [ ] Test tooltip functionality

- [ ] **`scripts/generate-gtfs-types.ts`** (25+ references)
  - [ ] Replace primary key mapping keys (25 occurrences)
  - [ ] Update to use GTFS_TABLES in generated code
  - [ ] Test type generation

### üîÑ Phase 4: Cleanup and Enforcement
- [ ] **Search and Replace Remaining References**
  - [ ] Search for remaining `'agency.txt'` patterns
  - [ ] Search for remaining `'stops.txt'` patterns
  - [ ] Search for remaining `'routes.txt'` patterns
  - [ ] Search for remaining `'trips.txt'` patterns
  - [ ] Search for remaining `'stop_times.txt'` patterns
  - [ ] Search for remaining `'calendar.txt'` patterns
  - [ ] Search for remaining other GTFS file patterns

- [ ] **Quality Assurance**
  - [ ] Run TypeScript compilation (`npm run typecheck`)
  - [ ] Run tests (`npm test`)
  - [ ] Run linter (`npm run lint`)
  - [ ] Test file upload functionality
  - [ ] Test validation functionality
  - [ ] Test map visualization
  - [ ] Test export functionality

- [ ] **Documentation and Prevention**
  - [ ] Add ESLint rule to prevent hardcoded GTFS strings
  - [ ] Update CLAUDE.md with new patterns
  - [ ] Add code examples to documentation
  - [ ] Update developer guidelines

### üéØ Final Verification
- [ ] **Zero hardcoded GTFS table strings** in codebase
- [ ] **All imports use GTFS_TABLES** constants
- [ ] **TypeScript compilation successful** with no errors
- [ ] **All tests pass** with no regressions
- [ ] **Linting passes** with no violations
- [ ] **Application functionality verified**
- [ ] **Documentation updated**

## Risk Assessment

**Risk Level:** üü° Medium

**Potential Issues:**
- Database operations are critical - need careful testing
- Large number of references to update
- Potential for missed references during migration

**Mitigation:**
- Incremental migration by file
- Comprehensive testing after each phase
- TypeScript will catch most issues at compile time
- Keep backward compatibility during transition

## Estimated Effort

- **Phase 1**: 2-3 hours (database operations)
- **Phase 2**: 2-3 hours (validation logic)
- **Phase 3**: 1-2 hours (utilities)
- **Phase 4**: 1 hour (cleanup)
- **Testing**: 2 hours (comprehensive testing)

**Total: ~8-11 hours**

## Success Criteria

1. **Zero hardcoded GTFS table name strings** in the codebase
2. **All table references use GTFS_TABLES constants**
3. **TypeScript compilation succeeds** with no type errors
4. **All tests pass** with no functional regressions
5. **ESLint rule prevents** future hardcoded strings
6. **Documentation updated** to reflect new patterns

## Notes

- Constants are automatically maintained by the spec generation process
- New GTFS files will automatically be included in future spec updates
- Migration can be done incrementally without breaking existing functionality
- TypeScript will provide compile-time safety during the migration process